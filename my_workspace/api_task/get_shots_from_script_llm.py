example_shot_str = """
镜头 1 (00:00-00:04)
场景: 阁楼书房，午夜。月光透过巨大的圆形窗户洒进来，照亮空气中浮动的微尘。书架上堆满天文学书籍，地上散落着星图。
运镜: 固定镜头。
角度/距离: 大远景，展示整个环境的静谧与凌乱。
镜头 2 (00:04-00:08)
场景: 星瑶坐在一张旧木桌前，面前是一台老式望远镜。
运镜: 缓慢地从右向左平移。
角度/距离: 全身镜头，侧后方角度，能看到她疲惫的背影。
镜头 3 (00:08-00:12)
场景: 桌上摊开的笔记本，上面是密密麻麻的演算公式和手绘的陨石坑草图。
运镜: 俯拍，缓慢向下推近。
角度/距离: 特写。
镜头 4 (00:12-00:16)
场景: 星瑶的侧脸，她打了个哈欠，揉了揉眼睛。
运镜: 固定。
角度/距离: 面部特写。表情是困倦但专注的。
镜头 5 (00:16-00:20)
场景: 她的手轻轻抚过一张月球表面的照片。
运镜: 跟随手的动作。
角度/距离: 手部特写。
镜头 6 (00:20-00:24)
场景: 星瑶抬头，透过望远镜的目镜看向窗外。
运镜: 从她的肩膀后方拍摄，焦点在她的眼睛上。
角度/距离: 过肩中景。
镜头 7 (00:24-00:28)
场景: 望远镜视角：一个清晰、明亮的月亮。
运镜: 固定。
角度/距离: 主观视角特写。
镜头 8 (00:28-00:32)
场景: 星瑶靠在椅子上，头向后仰，缓缓闭上眼睛。
运镜: 缓慢拉近。
角度/距离: 中景，正面。表情放松，进入梦乡。
镜头 9 (00:32-00:35)
场景: 她脖子上的月亮吊坠在月光下闪烁了一下。
运镜: 焦点转移到吊坠上。
角度/距离: 极特写。
镜头 10 (00:36-00:40)
场景: 阁楼中，桌上的几张星图纸张开始微微浮起。
运镜: 固定。
角度/距离: 中景。
镜头 11 (00:40-00:44)
场景: 熟睡的星瑶，身体也开始缓缓地、不真实地离开椅子，向上漂浮。
运镜: 仰拍，摄影机缓慢上升。
角度/距离: 全身镜头。
镜头 12 (00:44-00:48)
场景: 她漂浮在阁楼半空中，身体舒展，像在水中一样。
运镜: 环绕镜头。
角度/距离: 中全景。
镜头 13 (00:48-00:52)
场景: 阁楼的圆形窗户玻璃像水波一样化开，变成了通往宇宙的入口。
运镜: 从星瑶背后向前推进，穿过窗口。
角度/距离: 过肩镜头。
镜头 14 (00:52-00:57)
场景: 星瑶漂浮在太空中，背景是璀璨的星河和巨大的蓝色地球。
运镜: 缓慢拉远。
角度/距离: 大远景，展现渺小与宏大。
镜头 15 (00:57-01:01)
场景: 她的赤脚在虚空中轻轻点动，仿佛在走无形的阶梯。
运镜: 固定。
角度/距离: 脚部特写。
镜头 16 (01:01-01:05)
场景: 她闭着眼睛，脸上带着安详的微笑，感受着太空的寂静。
运镜: 缓慢推近。
角度/距离: 面部特写。
镜头 17 (01:05-01:10)
场景: 镜头转向她前进的方向，巨大的、布满陨石坑的月球表面越来越近。
运镜: 快速前推。
角度/距离: 主观视角。
镜头 18 (01:10-01:14)
场景: 她的脚尖轻轻落在银色的月球尘土上，荡开一圈涟漪般的尘埃。
运镜: 极慢动作。
角度/距离: 低角度特写。
镜头 19 (01:14-01:18)
场景: 星瑶站在月球表面，缓缓睁开眼睛，环顾四周。
运镜: 从她背后开始，环绕到正面。
角度/距离: 全身镜头。
镜头 20 (01:18-01:22)
场景: 她的眼中倒映出荒凉而壮美的月球地平线。
运镜: 固定。
角度/距离: 眼部极特写。
镜头 21 (01:22-01:27)
场景: 她迈出失重的第一步，动作缓慢而优雅，像宇航员一样。
运镜: 跟随拍摄，侧面。
角度/距离: 中景。
镜头 22 (01:27-01:32)
场景: 她蹲下身，伸出手，指尖触摸月球的土壤，感受那冰冷的质感。
运镜: 俯拍。
角度/距离: 手部特写。
镜头 23 (01:32-01:37)
场景: 一抬头，蓝色的地球正悬挂在漆黑的天幕上，像一颗宝石。
运镜: 缓慢向上摇。
角度/距离: 仰拍，广角。
镜头 24 (01:37-01:43)
场景: 星瑶对着远方的地球，伸出手，仿佛想要触摸它。
运镜: 从地球的“主观视角”看她。
角度/距离: 远景。表情是深深的眷恋与惊叹。
镜头 25 (01:44-01:49)
场景: 空气中开始飘浮着发光的、萤火虫般的星尘。
运镜: 虚焦到实焦。
角度/距离: 特写。
镜头 26 (01:49-01:54)
场景: 星瑶好奇地伸出双手，一粒星尘落在她的掌心，然后化作光芒消失。
运镜: 固定。
角度/距离: 中景，聚焦于手和脸部的互动。
镜头 27 (01:54-01:59)
场景: 她开心地笑了，在失重的月球上轻轻跳跃、旋转。
运镜: 升格（慢动作），手持跟拍，制造梦幻感。
角度/距离: 全身镜头。
镜头 28 (01:59-02:04)
场景: 她躺在一个巨大的陨石坑边缘，仰望星空。
运镜: 从正上方垂直俯拍，缓慢旋转。
角度/距离: 大俯拍。
镜头 29 (02:04-02:09)
场景: 她的头发在微弱的引力下微微飘动。
运镜: 固定。
角度/距离: 头部特写。
镜头 30 (02:09-02:18)
场景: 多个快速剪辑：月球上的脚印；地球的延时旋转；流星划过天际；她微笑的侧脸。
运镜: 快速跳剪。
角度/距离: 蒙太奇组合，包含各种景别。
镜头 31 (02:18-02:26)
场景: 回到漂浮的镜头，她再次在星海中遨游，这次表情更加自由和享受。
运镜: 环绕镜头。
角度/距离: 中全景。
镜头 32 (02:26-02:35)
场景: 她在虚空中，对着镜头，无声地、口型清晰地说出：“我在这里”。
运镜: 缓慢推近。
角度/距离: 面部特写。表情真诚而平静。
镜头 33 (02:35-02:43)
场景: 她的身体开始变得半透明，月球的景象透过她的身体显现出来。
运镜: 固定，通过特效实现。
角度/距离: 中景。
镜头 34 (02:43-02:52)
场景: 镜头快速拉回，穿过星海，穿过阁楼的窗户。
运镜: 快速拉远（倒放之前的推进镜头）。
角度/距离: 主观视角。
镜头 35 (02:53-02:59)
场景: 阁楼里，星瑶的身体轻轻地、缓缓地落回椅子上。
运镜: 缓慢下降。
角度/距离: 中景。
镜头 36 (02:59-03:06)
场景: 她猛地睁开眼睛，眼神清澈明亮，不再有之前的疲惫。
运镜: 极速推近至眼部。
角度/距离: 特写。
镜头 37 (03:06-03:13)
场景: 她站起身，走到窗前，看着窗外的真实月亮。
运镜: 跟随拍摄。
角度/距离: 背面中景。
镜头 38 (03:13-03:20)
场景: 她的嘴角浮现出一抹释然而宁静的微笑。
运镜: 从窗户玻璃的反光切到她的正面。
角度/距离: 面部特写。
镜头 39 (03:20-03:27)
场景: 她拿起桌上的一支笔，在空白的纸上，画下了一个悬挂在星空中的、孤独而美丽的地球。
运镜: 俯拍，聚焦于她的画。
角度/距离: 特写。
镜头 40 (03:27-03:40)
场景: 镜头缓慢拉远，星瑶在洒满月光的阁楼里安静地画着，整个房间似乎都因为她的梦境而变得明亮和充满希望。
运镜: 缓慢向后拉远，最终定格。
角度/距离: 大远景，与开篇镜头形成呼应，但色调更温暖。
"""

import logging
import os
import re
import sys
import platform
import asyncio
import traceback
import random
import time
import requests
import httpx
import json
from my_workspace.shot.bg_shot.camera import camera_motion_prompts
from my_workspace.restful_api import OpenaiClient

logging.basicConfig(filename="log.out", level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")
os.environ['http_proxy'] = ''
os.environ['https_proxy'] = ''
def is_windows():
    os_name = platform.system()
    if os_name.lower() == 'windows':
        logging.info("当前操作系统为 Windows")
        return True
    elif os_name.lower() == 'linux':
        logging.info("当前操作系统为 Linux")
        return False
    else:
        logging.info(f"当前操作系统为 {os_name}")
        return False
httpx_client = httpx.AsyncClient(limits=httpx.Limits(max_connections=1024, max_keepalive_connections=1024))
llm_cli = OpenaiClient(
    engine="qwen-plus-latest",
    api_key="sk-e3392a85198840f1b201495b34182350",
    # deepseek_api_key="sk-e3392a85198840f1b201495b34182350" if "172.17.209.45" in ips else "sk-813a748ccc884dcb879b00bd03b1520f",
    url="https://dashscope.aliyuncs.com/compatible-mode/v1",
    http_client=httpx_client,
)

########################################################## meta param ##########################################################
IS_SERVER_WINDOWS = True
COMFYUI_PATH = "f:/projects/ComfyUI" if is_windows() else "/workspace/ComfyUI"
COMFYUI_URL = "http://2903a9fa.r29.cpolar.top/" if IS_SERVER_WINDOWS else "http://127.0.0.1:8190"
LRC_BASE_DIR = "f:/projects/auto_video/mv/data" if is_windows() else "/workspace/auto_video/mv/data"
EXP_NM = "Dreaming_Deep"
TOPIC = "围绕沉浸式梦境与深海意象。整体氛围宁静、神秘且略带忧郁，表达了一种在深海中沉睡、漂流，与寂静对话的体验。"
PROCESS_TIME = 80 if IS_SERVER_WINDOWS else 200
# WORKFLOW_API_JSON_FILE = COMFYUI_PATH + "/my_workspace/workflow/animatediff_t2v_低帧率一致性_api.json"  # 你的工作流API格式文件
WORKFLOW_API_JSON_FILE = COMFYUI_PATH + "/my_workspace/workflow/wan生视频ghibli风格lora_api.json"  # 你的工作流API格式文件
OUTPUT_VIDEO_DIR = "f:/projects/ComfyUI/output/material/bg_shot" if IS_SERVER_WINDOWS else "/workspace/ComfyUI/output/material/bg_shot"
################################################################################################################################

if "PYTHONPATH" in os.environ:
    os.environ["PYTHONPATH"] += f":{COMFYUI_PATH}"
else:
    os.environ["PYTHONPATH"] = f"{COMFYUI_PATH}"
sys.path.insert(0, COMFYUI_PATH)  

bg_shots_all = json.load(open(f"{LRC_BASE_DIR}/{EXP_NM}.json", "r", encoding="utf-8"))
mv_shots = []
for itm in bg_shots_all:
    for sub in itm["lyric"].split("\t"):
        if sub:
            mv_shots.append(sub)

def queue_prompt(prompt_workflow):
    p = {"prompt": prompt_workflow}
    data = json.dumps(p).encode('utf-8')
    try:
        response = requests.post(
            f"{COMFYUI_URL}/prompt", data=data, timeout=60*10)
        response.raise_for_status()  # 如果请求失败则抛出异常
        return response.json()
    except requests.exceptions.RequestException as e:
        logging.info(f"Error queuing prompt: {e}")
        # if response:
        #     logging.info(f"Response content: {response.text}")
        return None


def set_workflow(current_workflow, **kwargs):

    save_video_node_ids = [k for k,v in current_workflow.items() if v.get("class_type") == "SaveVideo"]
    for save_video_node_id in save_video_node_ids:
        current_workflow[save_video_node_id]["inputs"]["filename_prefix"] = kwargs["output_filename_prefix"]

    posi_prompt_node_ids = [k for k,v in current_workflow.items() if v.get("class_type") == "CLIPTextEncode" and "Positive" in  v.get("_meta",{}).get("title", "")]
    for posi_prompt_node_id in posi_prompt_node_ids:
        current_workflow[posi_prompt_node_id]["inputs"]["text"] = kwargs["prompt"]

    k_sampler_node_ids = [k for k,v in current_workflow.items() if v.get("class_type") == "KSampler"]
    for k_sampler_node_id in k_sampler_node_ids:
        current_workflow[k_sampler_node_id]["inputs"]["seed"] = int(random.random()*10000000000)

    return current_workflow


# 加载工作流模板
with open(WORKFLOW_API_JSON_FILE, 'r', encoding="utf-8") as f:
    base_workflow = json.load(f)

charactor_str = """星耀：一位二十岁出头的年轻女性，长发及肩，气质安静内敛。她身穿一件米白色的宽松毛衣，一条深灰色的休闲裤，赤着脚。脖子上戴着一条细细的银色项链，吊坠是一个小小的月亮。她的眼神中带着一丝对现实的疲惫和对星空的无限向往。"""
type_str = "Studio Ghibli style"

async def main():
    iter_tt = 200
    cont = 0
    for it_cnt in range(0, iter_tt):
        random.shuffle(mv_shots)
        for i, segment in enumerate(re.split(r"镜头\s.*\n", example_shot_str)):
        # for lyric in mv_shots:
            try:
                prompt_dct = {
                    # "风格": "现代高清的吉卜力动画风格，细腻、干净、明亮的手绘风格，线条清晰，色彩鲜明自然，避免过度泛黄或昏暗，整体呈现温柔、通透且富有情感的动画质感。",
                    #无效 "风格": "现代高清的水彩画风格，柔和、清澈、明亮的手绘质感，色彩自然流畅，晕染效果细腻且有层次，避免过度浓重或失去透明感，整体呈现温暖、通透且富有情感的画面表达。"
                }

                prompt_dct.update({"歌词": str(i)})

                # prompt_prompt_role = f"""请为下面名为'{EXP_NM}'的歌曲的歌词:\n'{lyric}'\n添加mv画面内容描述，注意多使用现实生活中的场景和动作，背景要真实。要有更多的细节：其中1、主角是一个黄色长发蓝眼女孩；2、要给出背景景物细节；3、人物范围要给出是脸部特写，还是半身，还是全身，还是远景；人物是侧身，还是正面，还是背面；4、给出人物表情和动作；5、给出运镜与摄像角度方式；6、注重氛围的表达。以sd1.5的英文prompt（词语，词组）的形式输出该画面描述，不要有其他多余的输出"""
                # prompt_prompt_role_example = f"""(masterpiece, best quality, high detail), cinematic still, medium shot of a beautiful girl with long flowing blonde hair and blue eyes, sleeping peacefully, serene expression with a slight smile, she is lying on a bed of glowing moss and luminescent flowers in an enchanted forest at night, her hair fanned out around her head, ancient trees with soft moonlight filtering through the canopy, god rays, crepuscular rays, fireflies and glowing dust motes floating in the air, soft mist on the ground, ethereal and magical atmosphere, dreamlike, fantasy, high angle view looking down, slow dolly out."""
                # prompt_prompt_bg = f"""请为下面名为'{EXP_NM}'的歌曲的歌词:\n'{lyric}'\n添加mv画面内容描述，注意多使用现实生活中的场景和动作，背景要真实。要有更多的细节：其中1、不要有单人物特写，但可以有两三个人或群像或风景街景等景观；2、要给出背景景物细节；3、给出运镜与摄像角度方式；4、注重氛围的表达。以sd1.5的英文prompt（词语，词组）的形式输出该画面描述，不要有其他多余的输出"""
                # prompt_prompt_bg_example = f"""(masterpiece, best quality, high detail), a serene urban night street, dimly lit by warm streetlights, a light drizzle falling, reflections of city lights on the wet pavement, a couple walking under a shared umbrella in the distance, blurred silhouettes of people passing by, soft bokeh effect in the background, faint neon signs glowing on the sides of buildings, gentle fog slightly obscuring the far end of the street, camera pans slowly from the wet ground upward to reveal the scene, handheld camera movement with a slight sway, capturing the melancholic yet peaceful ambiance of the night, cinematic lighting with soft shadows, realistic textures and details of the wet concrete and brick walls, immersive atmosphere conveying a dreamlike stillness mixed with gentle movement.  """
                # if random.random() < 0.7:
                #     prompt_prompt = prompt_prompt_bg + "\n示例: "+prompt_prompt_bg_example
                # else:
                #     prompt_prompt = prompt_prompt_role + "\n示例: "+prompt_prompt_role_example
                # think = ""
                # text = "Studio Ghibli style, "
                # async for delta in llm_cli.async_stream_chat(chat_content="", history=[], prompt=prompt_prompt, max_length=256 * 16, temperature=0.4, enable_thinking=True):
                #     # logging.info(f"process_message_async: delta: {delta}")
                #     if "think" in delta:
                #         think += delta["think"]
                #     if "text" in delta:
                #         text += delta["text"]
                # prompt_dct.update({"画面内容": text})
                # camera_motion_id = int(random.random()*len(camera_motion_prompts))
                # prompt_dct["运镜"] = camera_motion_prompts[camera_motion_id]

                current_workflow = json.loads(json.dumps(base_workflow))  # 深拷贝工作流

                file_name_prefix = f"""{EXP_NM}_歌词#{prompt_dct["歌词"]}"""
                prompt_cur = " ".join([type_str,charactor_str, segment])
                print(prompt_cur)
                kwargs = {
                    "output_filename_prefix": os.path.join(OUTPUT_VIDEO_DIR, f"{file_name_prefix}"),
                    # "prompt": f"""{prompt_dct["画面内容"]}"""
                    "prompt":prompt_cur
                }
                current_workflow = set_workflow(current_workflow, **kwargs)

                logging.info(f"Processing video: cont:{cont}\t{kwargs}")
                result = queue_prompt(current_workflow)
                if result and 'prompt_id' in result:
                    prompt_id = result['prompt_id']
                    logging.info(f"""Queued with prompt_id: cont:{cont}\t{prompt_id}""")
                    cont += 1
                    # 此处可以添加等待任务完成的逻辑，例如轮询 /history/{prompt_id}
                else:
                    logging.info(f"Failed to queue {kwargs}")
                logging.info("-" * 30)
                time.sleep(PROCESS_TIME)  # 等待一段时间，避免请求过于频繁，并给ComfyUI一点处理时间
            except Exception as e:
                traceback.print_exc()
                logging.info(f"except: {e}")


    logging.info("All videos processed.")

if __name__=="__main__":
    asyncio.run(main())